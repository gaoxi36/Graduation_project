user                   root root;
worker_processes       auto;
worker_cpu_affinity    auto; 
error_log              /export/servers/logs/live/nginx-error.log   warn;
pid                    /export/servers/nginx/logs/nginx.pid;
worker_rlimit_nofile   65535;

events {
    use epoll;
    worker_connections 65535;
    multi_accept on;
}

http {
    include             mime.types;
    default_type        application/octet-stream;
    server_tokens       off;

    resolver 114.114.114.114;
    lua_package_path '/export/servers/nginx/plugins/vendor/?.lua;/export/servers/nginx/plugins/lua/?.lua;/usr/local/nginx/conf/lua/?.lua;/usr/local/share/lua/5.1/?.lua;;';
    lua_package_cpath '/export/servers/nginx/plugins/vendor/?.so;/export/servers/nginx/plugins/lua/?.so;/usr/local/nginx/conf/lua/?.so;/usr/local/share/lua/5.1/?.so;;';
    lua_shared_dict hls_dynamic_cache 50m;
    lua_shared_dict auth_cache 100m;

    init_by_lua_file        '/export/servers/nginx/plugins/lua/on_init.lua';
    init_worker_by_lua_file '/export/servers/nginx/plugins/lua/on_init_worker.lua';

    log_format main     '$time_local]$request_time]$http_j_forwarded_for]$http_jx_forwarded_for]'
                        '$upstream_cache_status]$status]$body_bytes_sent]$request]'
                        '$upstream_addr]$http_referer]$http_user_agent]$host]'
                        '$upstream_status]$upstream_response_time';

    log_custom live_access_log  '$time_iso8601   :$msec   :$request_id   :$remote_addr   :$server_addr'
                        '   :$live_method   :$live_scheme   :$host'
                        '   :$request_uri   :$uri   :$server_protocol   :$status'
                        '   :$upstream_cache_status   :$http_referer   :$sent_http_content_range'
                        '   :$content_type   :$server_name   :$request_time'
                        '   :$bytes_received   :$bytes_sent   :$body_bytes_sent'
                        '   :$request_length   :$upstream_bytes_received   :$upstream_connect_time'
                        '   :$upstream_header_time   :$upstream_response_time'
                        '   :$upstream_header_time   :$upstream_status'
                        '   :$via   :L1   :$charge_by   :LiveCDN'
                        '   :$hostname   :$http_user_agent   :$http_range   :$jdcdn_add_trace   :$tcpinfo_rtt'
                        '   :$tcpinfo_rttvar   :$tcpinfo_snd_cwnd   :$tcpinfo_rcv_space   :$sent_http_location'
                        '   :-   :-   :$user_pin   :-   :'
                        'END';

    proxy_cache_path /export/hls/proxy_cache levels=1:2 keys_zone=ts_cache:500m max_size=10g inactive=1m use_temp_path=off;

    jdcdn_add_trace        on;
    jdcdn_add_trace_header X-Trace;
                                
    access_log             off;
    access_log_custom      /export/servers/logs/live/nginx-non-gather.log  live_access_log;
 
    server_names_hash_bucket_size   512;
    client_header_buffer_size       32k;
    large_client_header_buffers     4 32k;
    client_max_body_size            5000m;
    sendfile                        on;
    tcp_nopush                      on;
    keepalive_timeout               90;
    tcp_nodelay                     on;
    limit_rate_after                10m;
    limit_rate                      2048k;
    client_body_buffer_size         2048k;
    proxy_connect_timeout           10;
    proxy_read_timeout              300;
    proxy_send_timeout              60;
    #proxy_buffering                off;
    proxy_buffer_size               512k;
    proxy_buffers                   2 512k;

    proxy_busy_buffers_size         512k;
    proxy_max_temp_file_size        0;
    proxy_temp_file_write_size      512k;
    proxy_set_header                J-Forwarded-For $remote_addr;
    proxy_set_header                Host $host;
    ssl_session_cache               shared:SSL:300m;
    #proxy_cache_use_stale          error timeout updating;
    #proxy_next_upstream            http_502 http_504 error invalid_header;
    #proxy_next_upstream_timeout    10;
    proxy_next_upstream_tries       2;

    #include geo.conf;
    #include denyip.conf;
    include domains/*.conf;
    
    #######################
    #real_ip_header J-Forwarded-For;
    #limit_req_zone $binary_remote_addr zone=jforwardfor:10m rate=1000r/s;
    #limit_req zone=jforwardfor burst=100;
    #limit_req_status 503;
    #limit_req_log_level info;
    ################################
}

stream {
    include domains/tcp_upstream.conf;
    server {
        listen 1935 so_keepalive=on reuseport;
        proxy_pass rtmp_cluster_normal;
        proxy_connect_timeout 10s;
        proxy_timeout 10s;
        proxy_protocol on;
        tcp_nodelay  on;
    }
}
